{"version":3,"sources":["../../../../../js/server/schema/mutations/fns/charactersMontageGet.js"],"names":["charactersGet","characters","cards","reduce","memo","character","card","find","text","exists","_memo","match","base64","characterTextShortenedGet","_text","lengthMax","tokens","map","token","length","trim","charactersConcatedGet","_characters","_character","characterIndex","findIndex","actor","slice","characterBase64sGet","then","res","result","Promise","resolve","charactersCompositedBase64Get","characterStreamsConcated","direction","reject","proc","split","_command","encoding","error","stdout","pipe","stdin","charactersMontageGet","characterBase64s","characterRows","characterBase64","index","characterBase64Row","characterRowStreams","characterRowStream","characterRowCompositedBase64s","characterRowCompositedStreams","charactersCompositedBase64","charactersMontageBase64"],"mappings":"AAAA;;;;;;;;;;;;;;;;;AAEA;;AAIA;;AACA;;AAGA;;AACA;;;;;;AAGA,IAAMA,aAAa,GAAG,SAAhBA,aAAgB,CACpBC,UADoB,EAEpBC,KAFoB,EAGjB;AAEH,SAAOD,UAAU,CAACE,MAAX,CACL,UACEC,IADF,EAEEC,SAFF,EAGK;AAEH,QAAMC,IAAI,GAAGJ,KAAK,CAACK,IAAN,CACX,UACED,IADF,EAEK;AAEH,aACEA,IAAI,CAACD,SAAL,KACAA,SAAS,CAACG,IAFZ;AAID,KATU,CAAb;AAYA,QAAMC,MAAM,GAAGL,IAAI,CAACG,IAAL,CACb,UACEG,KADF,EAEK;AAEH,aAEIL,SAAS,CAACG,IAAV,CACGG,KADH,CAEID,KAAK,CAACF,IAFV,CADF,IAOEE,KAAK,CAACF,IAAN,CACGG,KADH,CAEIN,SAAS,CAACG,IAFd,CARJ;AAcD,KAnBY,CAAf;;AAsBA,QACEF,IAAI,IACJ,CAACG,MAFH,EAGE;AAEA,2DACKL,IADL,oCAGOC,SAHP;AAIIO,QAAAA,MAAM,EAAEN,IAAI,CAACM;AAJjB;AAOD;;AAED,WACER,IADF;AAGD,GAzDI,EA0DL,EA1DK,CAAP;AA4DD,CAjED;;AAmEA,IAAMS,yBAAyB,GAAG,SAA5BA,yBAA4B,CAChCC,KADgC,EAEhCC,SAFgC,EAG7B;AAEH,MAAMC,MAAM,GAAG,mCACbF,KADa,EAGZG,GAHY,CAIX,gBAIK;AAAA,QAFDT,IAEC,QAFDA,IAEC;AAEH,WACEA,IADF;AAGD,GAbU,CAAf;AAgBA,MAAIA,IAAI,GAAGQ,MAAM,CAACb,MAAP,CACT,UACEC,IADF,EAEEc,KAFF,EAGK;AAEH,QACEd,IAAI,CAACe,MAAL,GACAJ,SAFF,EAGE;AAEA,aAAO,sBAEHX,IAFG,cAIHc,KAJG,gBAOJE,IAPI,EAAP;AAQD;;AAED,WACEhB,IADF;AAGD,GAxBQ,EAyBT,EAzBS,CAAX;;AA4BA,MACEI,IAAI,CAACW,MAAL,GACAL,KAAK,CAACK,MAFR,EAGE;AAEAX,IAAAA,IAAI,GAAG,kBAEHA,IAFG,gBAKJY,IALI,EAAP;AAMD;;AAED,SACEZ,IADF;AAGD,CAjED;;AAmEA,IAAMa,qBAAqB,GAAG,SAAxBA,qBAAwB,CAC5BC,WAD4B,EAEzB;AAEH,MAAMP,SAAS,GAAG,EAAlB;;AAEA,MAAId,UAAU,GAAGqB,WAAW,CAACnB,MAAZ,CACf,UACEC,IADF,EAEEmB,UAFF,EAGK;AAEH,QAAMf,IAAI,GAAGK,yBAAyB,CACpCU,UAAU,CAACf,IADyB,EAEpCO,SAFoC,CAAtC;AAKA,yDACKX,IADL,oCAGOmB,UAHP;AAIIf,MAAAA,IAAI,EAAJA;AAJJ;AAOD,GAlBc,EAmBf,EAnBe,CAAjB;;AAsBAP,EAAAA,UAAU,GAAGA,UAAU,CAACE,MAAX,CACX,UACEC,IADF,EAEEC,SAFF,EAGK;AAEH,QAAMmB,cAAc,GAAGpB,IAAI,CAACqB,SAAL,CACrB,UACEf,KADF,EAEK;AAEH,aACEA,KAAK,CAACgB,KAAN,CAAYlB,IAAZ,KACAH,SAAS,CAACqB,KAAV,CAAgBlB,IAFlB;AAID,KAToB,CAAvB;;AAYA,QACEgB,cAAc,IACd,CAFF,EAGE;AAEA,UAAMT,UAAS,GAAG,CAAlB;AAEA,UAAMP,IAAI,GAAG,sBAETK,yBAAyB,CACvBT,IAAI,CACFoB,cADE,CAAJ,CAGGhB,IAJoB,EAKvBO,UALuB,CAFhB,gBAUTF,yBAAyB,CACvBR,SAAS,CAACG,IADa,EAEvBO,UAFuB,CAVhB,gBAgBVK,IAhBU,EAAb;AAkBA,2DACKhB,IAAI,CAACuB,KAAL,CACD,CADC,EACEH,cADF,CADL,oCAKOpB,IAAI,CACLoB,cADK,CALX;AAQIhB,QAAAA,IAAI,EAAJA;AARJ,+CAUKJ,IAAI,CAACuB,KAAL,CACDH,cAAc,GAAG,CADhB,CAVL;AAcD;;AAED,yDACKpB,IADL,IAEEC,SAFF;AAID,GA/DU,EAgEX,EAhEW,CAAb;AAmEA,SACEJ,UADF;AAGD,CAlGD;;AAoGA,IAAM2B,mBAAmB,GAAG,SAAtBA,mBAAsB,CAC1B3B,UAD0B,EAEvB;AAEH,SAAOA,UAAU,CAACE,MAAX,CACL,UACEC,IADF,EAEEC,SAFF,EAGK;AAEH,WAAOD,IAAI,CAACyB,IAAL,CACL,UACEC,GADF,EAEK;AAEH,aAAO,yCACLzB,SAAS,CAACO,MADL,EAEL,0BAEIP,SAAS,CAACG,IAFd,oBAKGY,IALH,EAFK,EAQL,gCAAiB,GARZ,EASL,EATK,EAUL,EAVK,EAYJS,IAZI,CAaH,UACEE,MADF,EAEK;AAEH,6DACKD,GADL,IAEEC,MAFF;AAID,OArBE,CAAP;AAuBD,KA5BI,CAAP;AA8BD,GApCI,EAqCLC,OAAO,CAACC,OAAR,CACE,EADF,CArCK,CAAP;AAyCD,CA7CD;;AA+CA,IAAMC,6BAA6B,GAAG,SAAhCA,6BAAgC,CACpCC,wBADoC,EAGjC;AAAA,MADHC,SACG,uEADS,KACT;AAEH,SAAO,IAAIJ,OAAJ,CACL,UACEC,OADF,EAEEI,MAFF,EAGK;AAEH,QAAMC,IAAI,GAAG,yBACX,6HAMOF,SAAS,KAAK,KAAf,GACE,KADF,GACU,KAPhB,qFAYOA,SAAS,KAAK,KAAf,GACE,GADF,GACQ,GAbd,sDAkBGG,KAlBH,CAmBI,IAnBJ,EAqBGpC,MArBH,CAsBI,UACEC,IADF,EAEEoC,QAFF,EAGK;AAEH,aAAO,4BAEHpC,IAFG,cAIHoC,QAJG,sBAOJpB,IAPI,EAAP;AAQD,KAnCL,EAoCI,EApCJ,CADW,EAuCX;AACEqB,MAAAA,QAAQ,EAAE;AADZ,KAvCW,EA0CX,UACEC,KADF,EAEEC,MAFF,EAGK;AAEH,UACED,KADF,EAEE;AAEA,eAAOL,MAAM,CACXK,KADW,CAAb;AAGD;;AAED,aAAOT,OAAO,CACZ,gDAEIU,MAFJ,oBAKGvB,IALH,EADY,CAAd;AAQD,KAhEU,CAAb;AAmEAe,IAAAA,wBAAwB,CAACS,IAAzB,CACEN,IAAI,CAACO,KADP;AAGD,GA5EI,CAAP;AA8ED,CAnFD;;AAqFA,IAAMC,oBAAoB;AAAA,4FAAG,iBAC3B7C,UAD2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAKxBA,UAAU,CAACkB,MALa;AAAA;AAAA;AAAA;;AAAA,6CAQlBa,OAAO,CAACC,OAAR,CACL,IADK,CARkB;;AAAA;AAAA;AAAA,mBAaIL,mBAAmB,CAChD3B,UADgD,CAbvB;;AAAA;AAarB8C,YAAAA,gBAbqB;AAiBrBC,YAAAA,aAjBqB,GAiBLD,gBAAgB,CAAC5C,MAAjB,CACpB,UACEC,IADF,EAEE6C,eAFF,EAGEC,KAHF,EAIK;AAEH,kBACEA,KAAK,GAAG,CADV,EAEE;AAEA,qEACK9C,IAAI,CAACuB,KAAL,CACD,CADC,EACE,CAAC,CADH,CADL,kDAKOvB,IAAI,CACLA,IAAI,CAACe,MAAL,GAAc,CADT,CALX,IAQI8B,eARJ;AAWD;;AAED,mEACK7C,IADL,IAEE,CACE6C,eADF,CAFF;AAMD,aA9BmB,EA+BpB,EA/BoB,CAjBK;AAAA;AAAA,mBAmDOD,aAAa,CAAC7C,MAAd,CAChC,UACEC,IADF,EAEE+C,kBAFF,EAGK;AAEH,qBAAO/C,IAAI,CAACyB,IAAL,CACL,UACEC,GADF,EAEK;AAEH,uBAAO,8CACLqB,kBADK,EAGJtB,IAHI,CAIH,UACEE,MADF,EAEK;AAEH,uEACKD,GADL,IAEEC,MAFF;AAID,iBAZE,CAAP;AAcD,eAnBI,CAAP;AAqBD,aA3B+B,EA4BhCC,OAAO,CAACC,OAAR,CACE,EADF,CA5BgC,CAnDP;;AAAA;AAmDrBmB,YAAAA,mBAnDqB;AAAA;AAAA,mBAqFnBA,mBAAmB,CAACjD,MAApB,CACJ,UACEC,IADF,EAEEiD,kBAFF,EAGK;AAEH,qBAAOjD,IAAI,CAACyB,IAAL,CACL,UACEC,GADF,EAEK;AAEH,uBAAOI,6BAA6B,CAClCmB,kBADkC,EAElC,KAFkC,CAA7B,CAIJxB,IAJI,CAKH,UACEE,MADF,EAEK;AAEH,uEACKD,GADL,IAEEC,MAFF;AAID,iBAbE,CAAP;AAeD,eApBI,CAAP;AAsBD,aA5BG,EA6BJC,OAAO,CAACC,OAAR,CACE,EADF,CA7BI,CArFmB;;AAAA;AAoFrBqB,YAAAA,6BApFqB;AAAA;AAAA,mBAwHnB,8CACJA,6BADI,CAxHmB;;AAAA;AAuHrBC,YAAAA,6BAvHqB;AAAA;AAAA,mBA6HnBrB,6BAA6B,CACjCqB,6BADiC,EAEjC,QAFiC,CA7HV;;AAAA;AA4HrBC,YAAAA,0BA5HqB;AAAA,6CAmIzBA,0BAnIyB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAApBV,oBAAoB;AAAA;AAAA;AAAA,GAA1B;;;4FAuIe,kBACbxB,WADa,EAEbpB,KAFa;AAAA;AAAA;AAAA;AAAA;AAAA;AAKTD,YAAAA,UALS,GAKID,aAAa,CAC5BsB,WAD4B,EAE5BpB,KAF4B,CALjB;AAUbD,YAAAA,UAAU,GAAGoB,qBAAqB,CAChCpB,UADgC,CAAlC;AAVa;AAAA,mBAeL6C,oBAAoB,CACxB7C,UADwB,CAff;;AAAA;AAcPwD,YAAAA,uBAdO;AAAA,8CAoBXA,uBApBW;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["'use strict';\n\nimport {\n  exec\n} from 'child_process';\n\nimport wordsTokenizedGet from './wordsTokenizedGet';\nimport {\n  outputResGet\n} from '~/js/server/fns/variable';\nimport base64TextCompositedGet from './base64TextCompositedGet';\nimport base64MiffStreamsConcatedGet from \n  './base64MiffStreamsConcatedGet';\n\nconst charactersGet = (\n  characters,\n  cards\n) => {\n\n  return characters.reduce(\n    (\n      memo,\n      character\n    ) => {\n\n      const card = cards.find(\n        (\n          card\n        ) => {\n\n          return (\n            card.character ===\n            character.text\n          );\n        }\n      );\n\n      const exists = memo.find(\n        (\n          _memo\n        ) => {\n\n          return (\n            (\n              character.text\n                .match(\n                  _memo.text\n                )\n            ) ||\n            (\n              _memo.text\n                .match(\n                  character.text\n                )\n            )\n          );\n        }\n      );\n\n      if (\n        card &&\n        !exists\n      ) {\n\n        return [\n          ...memo,\n          {\n            ...character,\n            base64: card.base64\n          }\n        ];\n      }\n\n      return (\n        memo\n      );\n    },\n    []\n  );\n};\n\nconst characterTextShortenedGet = (\n  _text,\n  lengthMax\n) => {\n\n  const tokens = wordsTokenizedGet(\n    _text\n  )\n    .map(\n      (\n        {\n          text\n        }\n      ) => {\n\n        return (\n          text\n        );\n      }\n    );\n\n  let text = tokens.reduce(\n    (\n      memo,\n      token\n    ) => {\n\n      if (\n        memo.length < \n        lengthMax\n      ) {\n\n        return `\n          ${\n            memo\n          } ${\n            token\n          }\n        `\n          .trim();\n      }\n\n      return (\n        memo\n      );\n    },\n    ''\n  );\n\n  if (\n    text.length <\n    _text.length\n  ) {\n\n    text = `\n      ${\n        text\n      } ...\n    `\n      .trim();\n  }\n\n  return (\n    text\n  );\n};\n\nconst charactersConcatedGet = (\n  _characters\n) => {\n\n  const lengthMax = 10;\n\n  let characters = _characters.reduce(\n    (\n      memo,\n      _character\n    ) => {\n\n      const text = characterTextShortenedGet(\n        _character.text,\n        lengthMax\n      );\n\n      return [\n        ...memo,\n        {\n          ..._character,\n          text\n        }\n      ];\n    },\n    []\n  );\n\n  characters = characters.reduce(\n    (\n      memo,\n      character\n    ) => {\n\n      const characterIndex = memo.findIndex(\n        (\n          _memo\n        ) => {\n\n          return (\n            _memo.actor.text ===\n            character.actor.text\n          );\n        }\n      );\n\n      if (\n        characterIndex >= \n        0\n      ) {\n\n        const lengthMax = 5;\n\n        const text = `\n          ${\n            characterTextShortenedGet(\n              memo[\n                characterIndex\n              ]\n                .text,\n              lengthMax\n            )\n          } / ${\n            characterTextShortenedGet(\n              character.text,\n              lengthMax\n            )\n          }\n        `\n          .trim();\n\n        return [\n          ...memo.slice(\n            0, characterIndex\n          ),\n          {\n            ...memo[\n              characterIndex\n            ],\n            text\n          },\n          ...memo.slice(\n            characterIndex + 1\n          )\n        ];\n      }\n\n      return [\n        ...memo,\n        character\n      ];\n    },\n    []\n  );\n\n  return (\n    characters\n  );\n};\n\nconst characterBase64sGet = (\n  characters\n) => {\n\n  return characters.reduce(\n    (\n      memo,\n      character\n    ) => {\n\n      return memo.then(\n        (\n          res\n        ) => {\n\n          return base64TextCompositedGet(\n            character.base64,\n            `\n              ${\n                character.text\n              }\n            `\n              .trim(),\n            outputResGet() / 3.5,\n            50,\n            10\n          )\n            .then(\n              (\n                result\n              ) => {\n\n                return [\n                  ...res,\n                  result\n                ];\n              }\n            );\n        }\n      );\n    },\n    Promise.resolve(\n      []\n    )\n  );\n};\n\nconst charactersCompositedBase64Get = (\n  characterStreamsConcated,\n  direction = 'row'\n) => {\n\n  return new Promise(\n    (\n      resolve,\n      reject\n    ) => {\n\n      const proc = exec(\n        `\n          convert \n          \\\\(\n            miff:-\n            -bordercolor transparent\n            -border ${\n              (direction === 'row') ?\n                '2x0' : '0x2'\n            }\n            -gravity south\n            -background none\n            ${\n              (direction === 'row') ?\n                '+' : '-'\n            }append\n          \\\\)\n          png:-\n        `\n          .split(\n            /\\s/\n          )\n          .reduce(\n            (\n              memo,\n              _command\n            ) => {\n\n              return `\n                ${\n                  memo\n                } ${\n                  _command\n                }\n              `\n                .trim();\n            },\n            ''\n          ),\n        {\n          encoding: 'base64'\n        },\n        (\n          error,\n          stdout\n        ) => {\n\n          if (\n            error\n          ) {\n\n            return reject(\n              error\n            );\n          }\n\n          return resolve(\n            `\n              data:image/png;base64,${\n                stdout\n              }\n            `\n              .trim()\n          );\n        }\n      );\n\n      characterStreamsConcated.pipe(\n        proc.stdin\n      );\n    }\n  );\n};\n\nconst charactersMontageGet = async (\n  characters\n) => {\n\n  if (\n    !characters.length\n  ) {\n\n    return Promise.resolve(\n      null\n    );\n  }\n\n  const characterBase64s = await characterBase64sGet(\n    characters\n  );\n\n  const characterRows = characterBase64s.reduce(\n    (\n      memo,\n      characterBase64,\n      index\n    ) => {\n\n      if (\n        index % 2\n      ) {\n\n        return [\n          ...memo.slice(\n            0, -1\n          ),\n          [\n            ...memo[\n              memo.length - 1\n            ], \n            characterBase64\n          ]\n        ];\n      }\n\n      return [\n        ...memo,\n        [\n          characterBase64\n        ]\n      ];\n    },\n    []\n  );\n\n  const characterRowStreams = await characterRows.reduce(\n    (\n      memo,\n      characterBase64Row\n    ) => {\n\n      return memo.then(\n        (\n          res\n        ) => {\n\n          return base64MiffStreamsConcatedGet(\n            characterBase64Row\n          )\n            .then(\n              (\n                result\n              ) => {\n\n                return [\n                  ...res,\n                  result\n                ];\n              }\n            );\n        }\n      );\n    },\n    Promise.resolve(\n      []\n    )\n  );\n\n  const characterRowCompositedBase64s = \n    await characterRowStreams.reduce(\n      (\n        memo,\n        characterRowStream\n      ) => {\n\n        return memo.then(\n          (\n            res\n          ) => {\n\n            return charactersCompositedBase64Get(\n              characterRowStream,\n              'row'\n            )\n              .then(\n                (\n                  result\n                ) => {\n\n                  return [\n                    ...res,\n                    result\n                  ];\n                }\n              );\n          }\n        );\n      },\n      Promise.resolve(\n        []\n      )\n    );\n\n  const characterRowCompositedStreams = \n    await base64MiffStreamsConcatedGet(\n      characterRowCompositedBase64s\n    );\n\n  const charactersCompositedBase64 = \n    await charactersCompositedBase64Get(\n      characterRowCompositedStreams,\n      'column'\n    );\n\n  return (\n    charactersCompositedBase64\n  );\n};\n\nexport default async (\n  _characters,\n  cards\n) => {\n\n  let characters = charactersGet(\n    _characters,\n    cards\n  );\n\n  characters = charactersConcatedGet(\n    characters\n  );\n\n  const charactersMontageBase64 = \n    await charactersMontageGet(\n      characters\n    );\n\n  return (\n    charactersMontageBase64\n  );\n};\n"],"file":"charactersMontageGet.js"}