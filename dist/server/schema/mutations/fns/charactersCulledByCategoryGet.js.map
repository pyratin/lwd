{"version":3,"sources":["../../../../../js/server/schema/mutations/fns/charactersCulledByCategoryGet.js"],"names":["charactersUdAssignedGetFn","plotText","character","regExp","RegExp","text","trim","matchAll","reduce","memo","_matchAll","length","charactersUdAssignedGet","characters","Set","ud","pageCategoriesQueryGet","title","__charactersCategoryAssignedGetFn","categoryTitle","peopleCategoryStrings","peopleCategoryString","match","_charactersCategoryAssignedGetFn","categoryTitles","charactersCategoryAssignedGetFn","characterUd","encodeURIComponent","then","res","pageId","Object","keys","query","pages","categories","map","charactersCategoryAssignedGet","result","category","Promise","resolve","categoryWhitelistIsMatchGet","find","_categoryWhitelist","categoryBlacklistIsMatchedGet","_categoryBlacklist","charactersFilteredGet","_characters"],"mappings":"AAAA;;;;;;;;;;;;;;;;;AAEA;;AACA;;AACA;;;;;;AAEA,IAAMA,yBAAyB,GAAG,SAA5BA,yBAA4B,CAChCC,QADgC,EAEhCC,SAFgC,EAG7B;AAEH,MAAMC,MAAM,GAAG,IAAIC,MAAJ,CACb,kDAEIF,SAAS,CAACG,IAFd,gBAKGC,IALH,EADa,EAOb,GAPa,CAAf;AAUA,MAAMC,QAAQ,GAAG,oCACZN,QAAQ,CAACM,QAAT,CACDJ,MADC,CADY,EAKdK,MALc,CAMb,UACEC,IADF,EAEEC,SAFF,EAGK;AAEH,QACE,CAACD,IAAD,IACAC,SAAS,CAACC,MAFZ,EAGE;AAEA,aACED,SAAS,CACP,CADO,CADX;AAKD;;AAED,WACE,IADF;AAGD,GA1BY,EA2Bb,IA3Ba,CAAjB;AA8BA,SACEH,QADF;AAGD,CAhDD;;AAkDA,IAAMK,uBAAuB,GAAG,SAA1BA,uBAA0B,CAC9BC,UAD8B,EAE9BZ,QAF8B,EAG3B;AAEH,SAAOY,UAAU,CAACL,MAAX,CACL,UACEC,IADF,EAEEP,SAFF,EAGK;AAEH,+CACK,IAAIY,GAAJ,+CAEIL,IAFJ,oCAIMP,SAJN;AAKGa,MAAAA,EAAE,EAAEf,yBAAyB,CAC3BC,QAD2B,EAE3BC,SAF2B;AALhC,SADL;AAcD,GApBI,EAqBL,EArBK,CAAP;AAuBD,CA5BD;;AA8BA,IAAMc,sBAAsB,GAAG,SAAzBA,sBAAyB,CAC7BC,KAD6B,EAE1B;AAEH,kIAEIA,KAFJ;AAKD,CATD;;AAWA,IAAMC,iCAAiC,GAAG,SAApCA,iCAAoC,CACxCC,aADwC,EAErC;AAEH,MAAMC,qBAAqB,GAAG,CAC5B,QAD4B,EAE5B,MAF4B,EAG5B,OAH4B,EAI5B,KAJ4B,EAK5B,WAL4B,EAM5B,QAN4B,CAA9B;AASA,SAAOA,qBAAqB,CAACZ,MAAtB,CACL,UACEC,IADF,EAEEY,oBAFF,EAGK;AAEH,QACE,CAACZ,IAAD,IACAU,aAAa,CAACG,KAAd,CACE,IAAIlB,MAAJ,CACEiB,oBADF,EAEE,GAFF,CADF,CAFF,EAQE;AAEA,aACE,IADF;AAGD;;AAED,WACEZ,IADF;AAGD,GAxBI,EAyBL,KAzBK,CAAP;AA2BD,CAxCD;;AA0CA,IAAMc,gCAAgC,GAAG,SAAnCA,gCAAmC,CACvCC,cADuC,EAEpC;AAEH,SAAOA,cAAc,CAAChB,MAAf,CACL,UACEC,IADF,EAEEU,aAFF,EAGK;AAEH,QACE,CAACV,IAAD,IACAS,iCAAiC,CAC/BC,aAD+B,CAFnC,EAKE;AAEA,aACE,QADF;AAGD;;AAED,WACEV,IADF;AAGD,GArBI,EAsBL,IAtBK,CAAP;AAwBD,CA5BD;;AA8BA,IAAMgB,+BAA+B,GAAG,SAAlCA,+BAAkC,CACtCC,WADsC,EAEnC;AAEH,SAAO,gCACLV,sBAAsB,CACpBW,kBAAkB,CAChBD,WADgB,CADE,CADjB,EAOJE,IAPI,CAQH,UACEC,GADF,EAEK;AAEH,QAAMC,MAAM,GAAGC,MAAM,CAACC,IAAP,CACbH,GAAG,CAACI,KAAJ,CAAUC,KADG,EAGb,CAHa,CAAf;AAMA,QAAMV,cAAc,GAAGK,GAAG,CAACI,KAAJ,CAAUC,KAAV,CACrBJ,MADqB,EAGpBK,UAHoB,CAIpBC,GAJoB,CAKnB,gBAIK;AAAA,UAFDnB,KAEC,QAFDA,KAEC;AAEH,aACEA,KADF;AAGD,KAdkB,CAAvB;AAiBA,WAAOM,gCAAgC,CACrCC,cADqC,CAAvC;AAGD,GAtCE,CAAP;AAwCD,CA5CD;;AA8CA,IAAMa,6BAA6B,GAAG,SAAhCA,6BAAgC,CACpCxB,UADoC,EAEjC;AAEH,SAAOA,UAAU,CAACL,MAAX,CACL,UACEC,IADF,EAEEP,SAFF,EAGK;AAEH,WAAOO,IAAI,CAACmB,IAAL,CACL,UACEC,GADF,EAEK;AAEH,UACE3B,SAAS,CAACa,EADZ,EAEE;AAEA,eAAOU,+BAA+B,CACpCvB,SAAS,CAACa,EAD0B,CAA/B,CAGJa,IAHI,CAIH,UACEU,MADF,EAEK;AAEH,+DACKT,GADL,oCAGO3B,SAHP;AAIIqC,YAAAA,QAAQ,EACND,MADQ,GAGRA,MAHQ,GAIR;AARN;AAWD,SAnBE,CAAP;AAqBD;;AAED,2DACKT,GADL,IAEE3B,SAFF;AAID,KApCI,CAAP;AAsCD,GA5CI,EA6CLsC,OAAO,CAACC,OAAR,CACE,EADF,CA7CK,CAAP;AAiDD,CArDD;;AAuDA,IAAMC,2BAA2B,GAAG,SAA9BA,2BAA8B,CAClCxC,SADkC,EAE/B;AAEH,SAAO,wCACJyC,IADI,CAEH,UACEC,kBADF,EAEK;AAEH,WACEA,kBAAkB,KAClB1C,SAAS,CAACG,IAFZ;AAID,GAVE,CAAP;AAYD,CAhBD;;AAkBA,IAAMwC,6BAA6B,GAAG,SAAhCA,6BAAgC,CACpC3C,SADoC,EAEjC;AAEH,SAAO,wCACJyC,IADI,CAEH,UACEG,kBADF,EAEK;AAEH,WACEA,kBAAkB,KAClB5C,SAAS,CAACG,IAFZ;AAID,GAVE,CAAP;AAYD,CAhBD;;AAkBA,IAAM0C,qBAAqB,GAAG,SAAxBA,qBAAwB,CAC5BlC,UAD4B,EAEzB;AAEH,SAAOA,UAAU,CAACL,MAAX,CACL,UACEC,IADF,EAEEP,SAFF,EAGK;AAEH,YACE,IADF;AAIE,WACE,CAAC,CAACwC,2BAA2B,CAC3BxC,SAD2B,CAD/B;AAME,6DACKO,IADL,oCAGOP,SAHP;AAIIqC,UAAAA,QAAQ,EAAE;AAJd;;AAQF,WACE,CAAC,CAACM,6BAA6B,CAC7B3C,SAD6B,CADjC;AAME,eACEO,IADF;;AAIF,WACE,CAAC,CAACP,SAAS,CAACa,EAAZ,IACA,CAACb,SAAS,CAACqC,QAFb;AAKE,eACE9B,IADF;;AAIF;AAEE,6DACKA,IADL,IAEEP,SAFF;AAvCJ;AA4CD,GAlDI,EAmDL,EAnDK,EAqDJkC,GArDI,CAsDH,UACElC,SADF,EAEK;AAEH,WAAOA,SAAS,CAACa,EAAjB;AAEA,WACEb,SADF;AAGD,GA/DE,CAAP;AAiED,CArED;;;4FAuEe,iBACb8C,WADa,EAEb/C,QAFa;AAAA;AAAA;AAAA;AAAA;AAAA;AAKTY,YAAAA,UALS,GAKID,uBAAuB,CACtCoC,WADsC,EAEtC/C,QAFsC,CAL3B;AAAA;AAAA,mBAWLoC,6BAA6B,CACjCxB,UADiC,CAXxB;;AAAA;AAUbA,YAAAA,UAVa;AAebA,YAAAA,UAAU,GAAGkC,qBAAqB,CAChClC,UADgC,CAAlC;AAfa,6CAoBXA,UApBW;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["'use strict';\n\nimport mediawikiFetch from './mediawikiFetch';\nimport categoryWhitelistGet from './categoryWhitelistGet';\nimport categoryBlacklistGet from './categoryBlacklistGet';\n\nconst charactersUdAssignedGetFn = (\n  plotText,\n  character\n) => {\n\n  const regExp = new RegExp(\n    `\n      <a href=\"/wiki/([^\"]*)\"[^>]*>${\n        character.text\n      }</a>\n    `\n      .trim(),\n    'g'\n  );\n\n  const matchAll = [\n    ...plotText.matchAll(\n      regExp\n    )\n  ]\n    .reduce(\n      (\n        memo,\n        _matchAll\n      ) => {\n\n        if (\n          !memo &&\n          _matchAll.length\n        ) {\n\n          return (\n            _matchAll[\n              1\n            ]\n          );\n        }\n\n        return (\n          null\n        );\n      },\n      null\n    );\n\n  return (\n    matchAll\n  );\n};\n\nconst charactersUdAssignedGet = (\n  characters,\n  plotText\n) => {\n\n  return characters.reduce(\n    (\n      memo,\n      character\n    ) => {\n\n      return [\n        ...new Set(\n          [\n            ...memo,\n            {\n              ...character,\n              ud: charactersUdAssignedGetFn(\n                plotText,\n                character\n              )\n            }\n          ]\n        )\n      ];\n    },\n    []\n  );\n};\n\nconst pageCategoriesQueryGet = (\n  title\n) => {\n\n  return `\n    https://en.wikipedia.org/w/api.php?action=query&format=json&prop=categories&cllimit=500&redirects&titles=${\n      title\n    }\n  `;\n};\n\nconst __charactersCategoryAssignedGetFn = (\n  categoryTitle\n) => {\n\n  const peopleCategoryStrings = [\n    'female',\n    'male',\n    'woman',\n    'man',\n    'character',\n    'people'\n  ];\n\n  return peopleCategoryStrings.reduce(\n    (\n      memo,\n      peopleCategoryString\n    ) => {\n\n      if (\n        !memo &&\n        categoryTitle.match(\n          new RegExp(\n            peopleCategoryString,\n            'i'\n          )\n        )\n      ) {\n\n        return (\n          true\n        );\n      }\n\n      return (\n        memo\n      );\n    },\n    false\n  );\n};\n\nconst _charactersCategoryAssignedGetFn = (\n  categoryTitles\n) => {\n\n  return categoryTitles.reduce(\n    (\n      memo,\n      categoryTitle\n    ) => {\n\n      if (\n        !memo &&\n        __charactersCategoryAssignedGetFn(\n          categoryTitle\n        )\n      ) {\n\n        return (\n          'people'\n        );\n      }\n\n      return (\n        memo\n      );\n    },\n    null\n  );\n};\n\nconst charactersCategoryAssignedGetFn = (\n  characterUd\n) => {\n\n  return mediawikiFetch(\n    pageCategoriesQueryGet(\n      encodeURIComponent(\n        characterUd\n      )\n    )\n  )\n    .then(\n      (\n        res\n      ) => {\n\n        const pageId = Object.keys(\n          res.query.pages\n        )[\n          0\n        ];\n\n        const categoryTitles = res.query.pages[\n          pageId\n        ]\n          .categories\n          .map(\n            (\n              {\n                title\n              }\n            ) => {\n\n              return (\n                title\n              );\n            }\n          );\n\n        return _charactersCategoryAssignedGetFn(\n          categoryTitles\n        );\n      }\n    );\n};\n\nconst charactersCategoryAssignedGet = (\n  characters\n) => {\n\n  return characters.reduce(\n    (\n      memo,\n      character\n    ) => {\n\n      return memo.then(\n        (\n          res\n        ) => {\n\n          if (\n            character.ud\n          ) {\n\n            return charactersCategoryAssignedGetFn(\n              character.ud\n            )\n              .then(\n                (\n                  result\n                ) => {\n\n                  return [\n                    ...res,\n                    {\n                      ...character,\n                      category: (\n                        result\n                      ) ?\n                        result :\n                        null\n                    }\n                  ];\n                }\n              );\n          }\n\n          return [\n            ...res,\n            character\n          ];\n        }\n      );\n    },\n    Promise.resolve(\n      []\n    )\n  );\n};\n\nconst categoryWhitelistIsMatchGet = (\n  character\n) => {\n\n  return categoryWhitelistGet()\n    .find(\n      (\n        _categoryWhitelist\n      ) => {\n\n        return (\n          _categoryWhitelist ===\n          character.text\n        );\n      }\n    );\n};\n\nconst categoryBlacklistIsMatchedGet = (\n  character\n) => {\n\n  return categoryBlacklistGet()\n    .find(\n      (\n        _categoryBlacklist\n      ) => {\n\n        return (\n          _categoryBlacklist ===\n          character.text\n        );\n      }\n    );\n};\n\nconst charactersFilteredGet = (\n  characters\n) => {\n\n  return characters.reduce(\n    (\n      memo,\n      character\n    ) => {\n\n      switch (\n        true\n      ) {\n\n        case (\n          !!categoryWhitelistIsMatchGet(\n            character\n          )\n        ) :\n\n          return [\n            ...memo,\n            {\n              ...character,\n              category: 'people'\n            }\n          ];\n\n        case (\n          !!categoryBlacklistIsMatchedGet(\n            character\n          )\n        ) :\n\n          return (\n            memo\n          );\n\n        case (\n          !!character.ud &&\n          !character.category\n        ) :\n\n          return (\n            memo\n          );\n\n        default :\n\n          return [\n            ...memo,\n            character\n          ];\n      }\n    },\n    []\n  )\n    .map(\n      (\n        character\n      ) => {\n\n        delete character.ud;\n\n        return (\n          character\n        );\n      }\n    );\n};\n\nexport default async (\n  _characters,\n  plotText\n) => {\n\n  let characters = charactersUdAssignedGet(\n    _characters,\n    plotText\n  );\n\n  characters =\n    await charactersCategoryAssignedGet(\n      characters\n    );\n\n  characters = charactersFilteredGet(\n    characters\n  );\n\n  return (\n    characters\n  );\n};\n"],"file":"charactersCulledByCategoryGet.js"}