{"version":3,"sources":["../../../../../js/server/schema/mutations/fns/movieDataBasicGet.js"],"names":["titleEncodedGet","title","encodeURIComponent","pageMobileSectionQueryGet","trim","moviePageSectionTextGet","json","anchorName","section","remaining","sections","find","anchor","text","moviePageSectionTextsGet","anchorNames","reduce","memo","sectionText","pageTitleFromUrlGet","url","split","slice","castGetFn","castHtml","$","cheerio","load","castEl","remove","end","castText","textRegExp","RegExp","textMatch","match","actorUd","actorText","role","sbd","sentences","htmlRegExp","htmlMatch","actorLinkEl","length","attr","castGet","cast","toArray","html","actor","ud","plotGet","plotText","plotEl","paragraphs","p","paragraph","query","poster","lead","image","Object","values","urls","plot"],"mappings":"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","sourcesContent":["'use strict';\n\nimport cheerio from 'cheerio';\nimport sbd from 'sbd';\n\nimport mediawikiFetch from './mediawikiFetch';\nimport sentencesGet from './sentencesGet';\n\nconst titleEncodedGet = (\n  title\n) => {\n\n  return encodeURIComponent(\n    title\n  );\n};\n\nconst pageMobileSectionQueryGet = (\n  title\n) => {\n\n  return `\n    https://en.wikipedia.org/api/rest_v1/page/mobile-sections/${\n      titleEncodedGet(\n        title\n      )\n    }\n  `\n    .trim();\n};\n\nconst moviePageSectionTextGet = (\n  json,\n  anchorName\n) => {\n\n  const section = json.remaining.sections\n    .find(\n      (\n        {\n          anchor\n        }\n      ) => {\n\n        return (\n          anchor ===\n          anchorName\n        );\n      }\n    );\n\n  return (\n    section\n  ) &&\n    section.text;\n};\n\nconst moviePageSectionTextsGet = (\n  json,\n  anchorNames\n) => {\n\n  return anchorNames.reduce(\n    (\n      memo,\n      anchorName\n    ) => {\n\n      const sectionText = moviePageSectionTextGet(\n        json,\n        anchorName\n      );\n\n      return [\n        ...memo,\n        sectionText\n      ];\n    },\n    []\n  );\n};\n\nconst pageTitleFromUrlGet = (\n  url\n) => {\n\n  return url.split(\n    /\\//\n  )\n    .slice(\n      -1\n    )[\n      0\n    ];\n};\n\nconst castGetFn = (\n  castHtml\n) => {\n\n  const $ = cheerio.load(\n    castHtml\n  );\n\n  const castEl = $(\n    'span, sup'\n  )\n    .remove()\n    .end();\n\n  const castText = castEl.text();\n\n  const textRegExp = new RegExp(\n    `\n      ^(.*?)\\\\s+((?:as|â€”)(?:\\\\s|:)(\\\\n*.*)*)$\n    `\n      .trim()\n  );\n\n  const textMatch = castText.match(\n    textRegExp\n  );\n\n  let actorUd;\n\n  let actorText;\n\n  let role;\n\n  if (\n    textMatch\n  ) {\n\n    [\n      ,\n      actorText,\n      role\n    ] = textMatch;\n\n    role = sbd.sentences(\n      role\n    )[\n      0\n    ];\n\n    role = role.split(\n      ','\n    )[\n      0\n    ];\n  }\n\n  const htmlRegExp = /^<a/;\n\n  const htmlMatch = castHtml.match(\n    htmlRegExp\n  );\n\n  if (\n    actorText &&\n    role &&\n    htmlMatch\n  ) {\n\n    const actorLinkEl = $(\n      castEl\n    )\n      .find(\n        'a:first-child'\n      );\n\n    actorUd = (\n      actorLinkEl.length\n    ) ?\n      pageTitleFromUrlGet(\n        actorLinkEl.attr(\n          'href'\n        )\n      ) :\n      null;\n  }\n\n  return [\n    actorUd,\n    actorText,\n    role\n  ];\n};\n\nconst castGet = (\n  castText\n) => {\n\n  if (\n    !castText\n  ) {\n\n    return (\n      null\n    );\n  }\n\n  const $ = cheerio.load(\n    castText\n  );\n\n  const cast = $(\n    'li'\n  )\n    .toArray()\n    .reduce(\n      (\n        memo,\n        castEl\n      ) => {\n\n        const [\n          actorUd,\n          actorText,\n          role\n        ] = castGetFn(\n          $(castEl)\n            .html()\n        );\n\n        if (\n          actorText &&\n          role\n        ) {\n\n          return [\n            ...memo ||\n            [],\n            {\n              actor: {\n                ud: actorUd,\n                text: actorText\n              },\n              role\n            }\n          ];\n        }\n\n        return (\n          memo\n        );\n      },\n      null\n    );\n\n  return (\n    cast\n  );\n};\n\nconst plotGet = (\n  plotText\n) => {\n\n  if (\n    !plotText\n  ) {\n\n    return (\n      null\n    );\n  }\n\n  const $ = cheerio.load(\n    plotText\n  );\n\n  const plotEl = $(\n    'span, sup'\n  )\n    .remove()\n    .end();\n\n  let paragraphs = plotEl\n    .find(\n      'p'\n    )\n    .toArray();\n\n  if (\n    !paragraphs.length\n  ) {\n\n    return (\n      null\n    );\n  }\n\n  paragraphs = paragraphs.reduce(\n    (\n      memo,\n      p\n    ) => {\n\n      let paragraph = $(\n        p\n      )\n        .text();\n\n      return [\n        ...memo ||\n        [],\n        paragraph\n      ];\n    },\n    null\n  );\n\n  const sentences = sentencesGet(\n    paragraphs\n  );\n\n  return (\n    sentences\n  );\n};\n\nexport default async (\n  title\n) => {\n\n  const query = pageMobileSectionQueryGet(\n    title\n  );\n\n  const json = await mediawikiFetch(\n    query\n  );\n\n  const poster = (\n    json.lead?.image\n  ) ?\n    Object.values(\n      json.lead.image.urls\n    )[\n      0\n    ]:\n    null;\n\n  const anchorNames = [\n    'Cast',\n    'Plot'\n  ];\n\n  let [\n    castText,\n    plotText\n  ] = moviePageSectionTextsGet(\n    json,\n    anchorNames\n  );\n\n  const cast = castGet(\n    castText\n  );\n\n  const plot = plotGet(\n    plotText\n  );\n\n  return {\n    title,\n    poster,\n    cast,\n    plot,\n    castText,\n    plotText\n  };\n};\n"],"file":"movieDataBasicGet.js"}